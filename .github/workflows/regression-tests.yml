name: Regression Tests

on:
  push:
    branches: [ main, develop, mcp_regression_suite ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      os_image:
        description: 'Docker OS image to test'
        required: false
        default: 'almalinux:10'
        type: choice
        options:
          - almalinux:10
          - debian:12
          - ubuntu:24.04
          - almalinux:9
          - rocky:9
      server_env:
        description: 'Server environment'
        required: false
        default: 'live'
        type: choice
        options:
          - live
          - staging
      log_level:
        description: 'Log level'
        required: false
        default: 'minimal'
        type: choice
        options:
          - minimal
          - detailed

jobs:
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os_image:
          - almalinux:10
          # Temporarily disabled - enable after almalinux:10 is stable
          # - debian:12
          # - ubuntu:24.04
          # - almalinux:9
          # - rocky:9

    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install dependencies
        working-directory: test/regression
        run: |
          go mod download
          go mod verify

      - name: Pull Docker image
        run: |
          echo "Pulling Docker image: ${{ matrix.os_image }}"
          docker pull ${{ matrix.os_image }}

      - name: Configure test environment
        working-directory: test/regression
        run: |
          cat > .test.env << EOF
          # Auto-generated for GitHub Actions
          TEST_EXEC_MODE=container-systemd
          TEST_SERVER_ENV=${{ github.event.inputs.server_env || 'live' }}
          TEST_OS_IMAGE=${{ matrix.os_image }}
          TEST_LOG_LEVEL=${{ github.event.inputs.log_level || 'minimal' }}
          TEST_TIMEOUT=45m
          EOF

          echo "Test configuration:"
          cat .test.env

      - name: Set artifact name
        id: artifact
        run: |
          # Sanitize OS image name for artifact (replace : with -)
          SANITIZED_NAME=$(echo "${{ matrix.os_image }}" | sed 's/:/-/g')
          echo "name=test-results-${SANITIZED_NAME}" >> $GITHUB_OUTPUT

      - name: Run regression tests
        working-directory: test/regression
        env:
          CI: true
        run: |
          echo "=========================================="
          echo "Running regression tests"
          echo "OS Image: ${{ matrix.os_image }}"
          echo "Server Environment: ${{ github.event.inputs.server_env || 'live' }}"
          echo "Log Level: ${{ github.event.inputs.log_level || 'minimal' }}"
          echo "=========================================="

          go test -v -timeout 45m -run TestRegressionSuite 2>&1 | tee test-output.log

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: |
            test/regression/test-output.log
          retention-days: 30

      - name: Cleanup Docker containers
        if: always()
        run: |
          echo "Cleaning up Docker containers..."
          docker ps -a --filter "name=mcp-test-" -q | xargs -r docker rm -f 2>/dev/null || true
          docker images --filter "reference=*-systemd" -q | xargs -r docker rmi -f 2>/dev/null || true

      - name: Generate test summary
        if: always()
        working-directory: test/regression
        run: |
          echo "## Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OS Image:** \`${{ matrix.os_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Server Environment:** \`${{ github.event.inputs.server_env || 'live' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Log Level:** \`${{ github.event.inputs.log_level || 'minimal' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output.log ]; then
            echo "### Test Output Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -50 test-output.log >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  quick-test:
    name: Quick Test (Debian 12)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install dependencies
        working-directory: test/regression
        run: go mod download

      - name: Pull Docker image
        run: docker pull almalinux:10

      - name: Configure test environment
        working-directory: test/regression
        run: |
          cat > .test.env << EOF
          TEST_EXEC_MODE=container-systemd
          TEST_SERVER_ENV=live
          TEST_OS_IMAGE=almalinux:10
          TEST_LOG_LEVEL=minimal
          TEST_TIMEOUT=45m
          EOF

      - name: Run quick regression test
        working-directory: test/regression
        env:
          CI: true
        run: go test -v -timeout 45m -run TestRegressionSuite

      - name: Cleanup
        if: always()
        run: docker ps -a --filter "name=mcp-test-" -q | xargs -r docker rm -f 2>/dev/null || true

  test-status:
    name: All Tests Status
    runs-on: ubuntu-latest
    needs: [regression-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.regression-tests.result }}" = "success" ]; then
            echo "✅ All regression tests passed!"
            exit 0
          else
            echo "❌ Some regression tests failed"
            exit 1
          fi
