name: Regression Tests

on:
  push:
    branches: [ main, develop, mcp_regression_suite ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      os_image:
        description: 'Docker OS image to test'
        required: false
        default: 'almalinux:10'
        type: choice
        options:
          - almalinux:10
          - debian:12
          - ubuntu:24.04
          - almalinux:9
          - rocky:9
      server_env:
        description: 'Server environment'
        required: false
        default: 'live'
        type: choice
        options:
          - live
          - staging
      pg_version:
        description: 'PostgreSQL version'
        required: false
        default: '18'
        type: choice
        options:
          - '16'
          - '17'
          - '18'
      log_level:
        description: 'Log level'
        required: false
        default: 'minimal'
        type: choice
        options:
          - minimal
          - detailed

jobs:
  regression-tests:
    name: Regression Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        os_image:
          - almalinux:10
          - debian:12
          # Temporarily disabled - enable after stable
          # - ubuntu:24.04
          # - almalinux:9
          # - rocky:9

    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install dependencies
        working-directory: test/regression
        run: |
          go mod download
          go mod verify

      - name: Install aha for HTML conversion
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y aha

      - name: Clean up Docker
        run: |
          echo "Cleaning up old Docker images and containers..."
          docker ps -a --filter "name=mcp-test-" -q | xargs -r docker rm -f 2>/dev/null || true
          docker images --filter "reference=*-systemd" -q | xargs -r docker rmi -f 2>/dev/null || true
          docker image prune -f

      - name: Pull Docker image
        run: |
          echo "Pulling Docker image: ${{ matrix.os_image }}"
          docker pull ${{ matrix.os_image }}
          echo "Verifying pulled image:"
          docker images ${{ matrix.os_image }}

      - name: Configure test environment
        working-directory: test/regression
        run: |
          cat > .test.env << EOF
          # Auto-generated for GitHub Actions
          TEST_EXEC_MODE=container-systemd
          TEST_SERVER_ENV=${{ github.event.inputs.server_env || 'live' }}
          TEST_PG_VERSION=${{ github.event.inputs.pg_version || '18' }}
          TEST_OS_IMAGE=${{ matrix.os_image }}
          TEST_LOG_LEVEL=${{ github.event.inputs.log_level || 'minimal' }}
          TEST_TIMEOUT=45m
          EOF

          echo "Test configuration:"
          cat .test.env

      - name: Set artifact name
        id: artifact
        run: |
          # Sanitize OS image name for artifact (replace : with -)
          SANITIZED_NAME=$(echo "${{ matrix.os_image }}" | sed 's/:/-/g')
          echo "name=test-results-${SANITIZED_NAME}" >> $GITHUB_OUTPUT

      - name: Run regression tests
        working-directory: test/regression
        env:
          CI: true
          TEST_EXEC_MODE: container-systemd
          TEST_SERVER_ENV: ${{ github.event.inputs.server_env || 'live' }}
          TEST_PG_VERSION: ${{ github.event.inputs.pg_version || '18' }}
          TEST_OS_IMAGE: ${{ matrix.os_image }}
          TEST_LOG_LEVEL: ${{ github.event.inputs.log_level || 'minimal' }}
          TEST_TIMEOUT: 45m
        run: |
          echo "=========================================="
          echo "Running regression tests"
          echo "OS Image: ${{ matrix.os_image }}"
          echo "Server Environment: ${{ github.event.inputs.server_env || 'live' }}"
          echo "PostgreSQL Version: ${{ github.event.inputs.pg_version || '18' }}"
          echo "Log Level: ${{ github.event.inputs.log_level || 'minimal' }}"
          echo "=========================================="

          # Run tests and capture output
          set +e
          go test -v -timeout 45m -run TestRegressionSuite > test-output.log 2>&1
          TEST_EXIT_CODE=$?
          set -e

          # Display output up to and including the final separator line (80 =)
          # This removes the Go test framework summary that comes after our custom summary
          awk '/^={80}$/ {print; if (printed_summary) exit} {print} /TEST SUITE (PASSED|FAILED)/ {printed_summary=1}' test-output.log

          # Create a filtered summary file with just the table for artifacts
          awk '/^={80}$/ {print; if (printed_summary) exit} {print} /TEST SUITE (PASSED|FAILED)/ {printed_summary=1}' test-output.log > test-summary.log

          # Convert ANSI colors to HTML for beautiful artifact viewing
          if command -v aha &> /dev/null; then
            cat test-summary.log | aha --black --title "Test Summary" > test-summary.html
          fi

          exit $TEST_EXIT_CODE

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: |
            test/regression/test-output.log
            test/regression/test-summary.log
            test/regression/test-summary.html
          retention-days: 30

      - name: Cleanup Docker containers
        if: always()
        run: |
          echo "Cleaning up Docker containers..."
          docker ps -a --filter "name=mcp-test-" -q | xargs -r docker rm -f 2>/dev/null || true
          docker images --filter "reference=*-systemd" -q | xargs -r docker rmi -f 2>/dev/null || true

      - name: Generate test summary
        if: always()
        working-directory: test/regression
        run: |
          echo "## Regression Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**OS Image:** \`${{ matrix.os_image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Server Environment:** \`${{ github.event.inputs.server_env || 'live' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**PostgreSQL Version:** \`${{ github.event.inputs.pg_version || '18' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Log Level:** \`${{ github.event.inputs.log_level || 'minimal' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f test-output.log ]; then
            echo "### Test Output Summary" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            tail -50 test-output.log >> $GITHUB_STEP_SUMMARY || true
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

  quick-test:
    name: Quick Test (Debian 12)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    timeout-minutes: 45

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Install dependencies
        working-directory: test/regression
        run: go mod download

      - name: Pull Docker image
        run: docker pull almalinux:10

      - name: Configure test environment
        working-directory: test/regression
        run: |
          cat > .test.env << EOF
          TEST_EXEC_MODE=container-systemd
          TEST_SERVER_ENV=live
          TEST_PG_VERSION=18
          TEST_OS_IMAGE=almalinux:10
          TEST_LOG_LEVEL=minimal
          TEST_TIMEOUT=45m
          EOF

      - name: Run quick regression test
        working-directory: test/regression
        env:
          CI: true
          TEST_EXEC_MODE: container-systemd
          TEST_SERVER_ENV: live
          TEST_PG_VERSION: 18
          TEST_OS_IMAGE: almalinux:10
          TEST_LOG_LEVEL: minimal
          TEST_TIMEOUT: 45m
        run: go test -v -timeout 45m -run TestRegressionSuite

      - name: Cleanup
        if: always()
        run: docker ps -a --filter "name=mcp-test-" -q | xargs -r docker rm -f 2>/dev/null || true

  test-status:
    name: All Tests Status
    runs-on: ubuntu-latest
    needs: [regression-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          if [ "${{ needs.regression-tests.result }}" = "success" ]; then
            echo "✅ All regression tests passed!"
            exit 0
          else
            echo "❌ Some regression tests failed"
            exit 1
          fi
