name: Release

on:
    push:
        tags:
            - 'v*'

permissions:
    contents: write
    packages: write

jobs:
    # Build Web UI once (architecture-independent)
    build-web:
        name: Build Web UI
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: web/package-lock.json

            - name: Install Node.js dependencies
              run: |
                  cd web
                  npm ci

            - name: Build Web UI
              run: |
                  cd web
                  npm run build
                  ls -la dist/

            - name: Verify Web UI build
              run: |
                  if [ ! -d "web/dist" ]; then
                    echo "Error: web/dist directory not found"
                    exit 1
                  fi
                  if [ ! -f "web/dist/index.html" ]; then
                    echo "Error: web/dist/index.html not found"
                    exit 1
                  fi
                  echo "Web UI build successful"

            - name: Upload Web UI artifact
              uses: actions/upload-artifact@v4
              with:
                  name: web-dist
                  path: web/dist/
                  retention-days: 1

    # Build for x86_64 architecture
    build-amd64:
        name: Build x86_64
        runs-on: ubuntu-latest
        needs: build-web
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Fetch all tags
              run: git fetch --force --tags

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.24'
                  cache: true

            - name: Download Web UI artifact
              uses: actions/download-artifact@v4
              with:
                  name: web-dist
                  path: web/dist

            - name: Verify Web UI downloaded
              run: ls -la web/dist/

            - name: Run Go unit tests
              run: |
                  go test -v ./internal/mcp/... ./internal/auth/... ./internal/config/... ./internal/crypto/... ./internal/database/... ./internal/resources/... ./internal/tools/... ./internal/chat/... ./internal/llmproxy/... ./internal/search/... ./internal/prompts/... ./internal/conversations/... ./internal/kbdatabase/... ./internal/kbembed/... ./internal/kbchunker/...

            - name: Configure git for private repo access
              run: |
                  # Configure git to use PGEDGE_BUILDER_TOKEN for authentication
                  git config --global url."https://x-access-token:${PGEDGE_BUILDER_TOKEN}@github.com/".insteadOf "https://github.com/"
              env:
                  PGEDGE_BUILDER_TOKEN: ${{ secrets.PGEDGE_BUILDER_TOKEN }}

            - name: Setup API keys for kb-builder
              run: |
                  # Create temporary API key files for all three providers
                  mkdir -p /tmp/api-keys
                  echo "${{ secrets.OPENAI_API_KEY }}" > /tmp/api-keys/openai-key
                  echo "${{ secrets.VOYAGE_API_KEY }}" > /tmp/api-keys/voyage-key
                  chmod 600 /tmp/api-keys/*

            - name: Configure kb-builder for cloud providers
              run: |
                  # Create a copy and modify it to use cloud endpoints and output kb.db
                  cp examples/pgedge-nla-kb-builder.yaml examples/pgedge-nla-kb-builder-build.yaml
                  # Update database path
                  sed -i 's|database_path: "bin/pgedge-nla-kb.db"|database_path: "bin/kb.db"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure Ollama to use cloud endpoint
                  sed -i 's|endpoint: "http://localhost:11434"|endpoint: "https://ollama.com"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure OpenAI to use temporary key file
                  sed -i 's|api_key_file: "~/.openai-api-key"|api_key_file: "/tmp/api-keys/openai-key"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure Voyage to use temporary key file
                  sed -i 's|api_key_file: "~/.voyage-api-key"|api_key_file: "/tmp/api-keys/voyage-key"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Convert SSH URLs to HTTPS for authentication with token
                  sed -i 's|git@github.com:|https://github.com/|g' examples/pgedge-nla-kb-builder-build.yaml
                  echo "Modified config for build (all three providers enabled):"
                  grep -A3 "openai:\|voyage:\|ollama:" examples/pgedge-nla-kb-builder-build.yaml | head -30

            - name: Run GoReleaser (amd64 only)
              uses: goreleaser/goreleaser-action@v6
              with:
                  distribution: goreleaser
                  version: latest
                  args: release --clean --config .goreleaser-amd64.yaml
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                  VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
                  OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}

            - name: Upload amd64 artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-artifacts-amd64
                  path: |
                      dist/*.tar.gz
                      dist/*.zip
                  retention-days: 1

    # Build for ARM64 architecture
    build-arm64:
        name: Build ARM64
        runs-on: ubuntu-24.04-arm64
        needs: build-web
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Fetch all tags
              run: git fetch --force --tags

            - name: Set up Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.24'
                  cache: true

            - name: Download Web UI artifact
              uses: actions/download-artifact@v4
              with:
                  name: web-dist
                  path: web/dist

            - name: Verify Web UI downloaded
              run: ls -la web/dist/

            - name: Run Go unit tests
              run: |
                  go test -v ./internal/mcp/... ./internal/auth/... ./internal/config/... ./internal/crypto/... ./internal/database/... ./internal/resources/... ./internal/tools/... ./internal/chat/... ./internal/llmproxy/... ./internal/search/... ./internal/prompts/... ./internal/conversations/... ./internal/kbdatabase/... ./internal/kbembed/... ./internal/kbchunker/...

            - name: Configure git for private repo access
              run: |
                  # Configure git to use PGEDGE_BUILDER_TOKEN for authentication
                  git config --global url."https://x-access-token:${PGEDGE_BUILDER_TOKEN}@github.com/".insteadOf "https://github.com/"
              env:
                  PGEDGE_BUILDER_TOKEN: ${{ secrets.PGEDGE_BUILDER_TOKEN }}

            - name: Setup API keys for kb-builder
              run: |
                  # Create temporary API key files for all three providers
                  mkdir -p /tmp/api-keys
                  echo "${{ secrets.OPENAI_API_KEY }}" > /tmp/api-keys/openai-key
                  echo "${{ secrets.VOYAGE_API_KEY }}" > /tmp/api-keys/voyage-key
                  chmod 600 /tmp/api-keys/*

            - name: Configure kb-builder for cloud providers
              run: |
                  # Create a copy and modify it to use cloud endpoints and output kb.db
                  cp examples/pgedge-nla-kb-builder.yaml examples/pgedge-nla-kb-builder-build.yaml
                  # Update database path
                  sed -i 's|database_path: "bin/pgedge-nla-kb.db"|database_path: "bin/kb.db"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure Ollama to use cloud endpoint
                  sed -i 's|endpoint: "http://localhost:11434"|endpoint: "https://ollama.com"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure OpenAI to use temporary key file
                  sed -i 's|api_key_file: "~/.openai-api-key"|api_key_file: "/tmp/api-keys/openai-key"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Configure Voyage to use temporary key file
                  sed -i 's|api_key_file: "~/.voyage-api-key"|api_key_file: "/tmp/api-keys/voyage-key"|' examples/pgedge-nla-kb-builder-build.yaml
                  # Convert SSH URLs to HTTPS for authentication with token
                  sed -i 's|git@github.com:|https://github.com/|g' examples/pgedge-nla-kb-builder-build.yaml
                  echo "Modified config for build (all three providers enabled):"
                  grep -A3 "openai:\|voyage:\|ollama:" examples/pgedge-nla-kb-builder-build.yaml | head -30

            - name: Run GoReleaser (arm64 only)
              uses: goreleaser/goreleaser-action@v6
              with:
                  distribution: goreleaser
                  version: latest
                  args: release --clean --config .goreleaser-arm64.yaml
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                  VOYAGE_API_KEY: ${{ secrets.VOYAGE_API_KEY }}
                  OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}

            - name: Upload arm64 artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-artifacts-arm64
                  path: |
                      dist/*.tar.gz
                      dist/*.zip
                  retention-days: 1

    # Combine artifacts and create release
    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [build-amd64, build-arm64]
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download amd64 artifacts
              uses: actions/download-artifact@v4
              with:
                  name: release-artifacts-amd64
                  path: dist/

            - name: Download arm64 artifacts
              uses: actions/download-artifact@v4
              with:
                  name: release-artifacts-arm64
                  path: dist/

            - name: Download Web UI artifact
              uses: actions/download-artifact@v4
              with:
                  name: web-dist
                  path: web/dist

            - name: List all artifacts
              run: |
                  echo "=== All release artifacts ==="
                  ls -lh dist/
                  echo ""
                  echo "=== Web UI files ==="
                  ls -lh web/dist/

            - name: Create Web UI archive
              run: |
                  mkdir -p dist
                  cd web
                  tar -czf ../dist/pgedge-nla-web_${GITHUB_REF_NAME#v}_noarch.tar.gz dist/ README.md ../LICENCE.md
                  cd ..
                  echo "Web UI archive created:"
                  ls -lh dist/pgedge-nla-web_*.tar.gz

            - name: Generate checksums
              run: |
                  cd dist
                  sha256sum *.tar.gz *.zip > checksums.txt
                  cat checksums.txt

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/*.tar.gz
                      dist/*.zip
                      dist/checksums.txt
                  generate_release_notes: true
                  draft: false
                  prerelease: false
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Upload final artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: release-artifacts-all
                  path: |
                      dist/*.tar.gz
                      dist/*.zip
                      dist/checksums.txt
                  retention-days: 90
