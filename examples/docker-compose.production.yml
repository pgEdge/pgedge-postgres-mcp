# Production Docker Compose configuration for pgEdge Natural Language Agent
#
# This configuration uses pre-built images from GitHub Container Registry
# and includes production-ready settings like resource limits, healthchecks,
# and proper restart policies.

version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:17-alpine
    container_name: pgedge-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - pgedge-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # MCP Server
  # Image variants:
  #   - ghcr.io/pgedge/mcp-server:latest         Base image (~50MB, no KB)
  #   - ghcr.io/pgedge/mcp-server:latest-with-kb Image with KB (~300-500MB)
  # Use the -with-kb variant for built-in knowledgebase, or use the base image
  # and mount your own KB via volume (see volumes section below).
  pgedge-mcp-server:
    image: ghcr.io/pgedge/mcp-server:${VERSION:-latest-with-kb}
    container_name: pgedge-mcp-server
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGEDGE_POSTGRES_CONNECTION_STRING: postgres://postgres:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-postgres}?sslmode=disable
      PGEDGE_MCP_LOG_LEVEL: ${LOG_LEVEL:-info}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
    volumes:
      - ./config/mcp-server.yaml:/etc/pgedge/mcp-server.yaml:ro
      # Uncomment the following line to use a custom KB with the base image
      # instead of using the -with-kb image variant:
      # - ./kb/kb.db:/usr/share/pgedge/nla-kb/kb.db:ro
      - server-data:/var/lib/pgedge/mcp-server
      - server-logs:/var/log/pgedge/mcp-server
    ports:
      - "${SERVER_PORT:-8080}:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - pgedge-network
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # Web UI
  pgedge-nla-web:
    image: ghcr.io/pgedge/nla-web:${VERSION:-latest}
    container_name: pgedge-nla-web
    depends_on:
      pgedge-mcp-server:
        condition: service_healthy
    ports:
      - "${WEB_PORT:-80}:80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 3s
      retries: 3
    restart: unless-stopped
    networks:
      - pgedge-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

volumes:
  postgres-data:
    driver: local
  server-data:
    driver: local
  server-logs:
    driver: local

networks:
  pgedge-network:
    driver: bridge
