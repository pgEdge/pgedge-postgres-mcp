# pgEdge MCP Server

[![Build](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Build/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/build.yml)
[![Tests](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Tests/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/test.yml)

A Model Context Protocol (MCP) server written in Go that enables natural language queries against PostgreSQL databases. The server uses AI (Anthropic Claude or Ollama) to translate natural language questions into SQL queries by analyzing database metadata including table names, view names, column names, data types, and comments from pg_description.

> ðŸš§ WARNING
>
> This code was entirely generated by Claude Code. It has not been human reviewed and MUST NOT be put into production or released as stable code without a thorough review!

## Features

- **Dual LLM Provider Support**: Choose between Anthropic Claude (cloud) or Ollama (local, free) for natural language to SQL conversion
- **Natural Language to SQL**: Convert plain English questions into SQL queries using AI
- **Read-Only Protection**: All generated queries are executed in read-only transactions to prevent accidental or malicious data modifications
- **Comprehensive Schema Analysis**: Extracts and utilizes table/view names, column information, data types, nullability, and pg_description comments
- **Multi-Database Support**: Query multiple PostgreSQL databases dynamically by specifying connection strings in queries
- **Configuration Management**: View, modify, and get baseline configuration recommendations for NEW PostgreSQL installations
- **Bloat Analysis**: Analyze tables and indexes for bloat to determine when vacuuming or reindexing is required
- **Configuration File Access**: Read PostgreSQL configuration files (postgresql.conf, pg_hba.conf, pg_ident.conf) and server logs
- **MCP Protocol**: Implements the Model Context Protocol with support for stdio and streaming HTTP/HTTPS (with or without TLS)
- **API Token Authentication**: Built-in token authentication with expiration support for HTTP/HTTPS mode
- **Eleven MCP Tools**: Execute queries, retrieve schema, modify configuration, analyze bloat, get server info, and more - See **[Tools Documentation](docs/TOOLS.md)**
- **Nine MCP Resources**: System information and PostgreSQL statistics (pg_stat_* views) - See **[Resources Documentation](docs/RESOURCES.md)**

## Quick Start

### Prerequisites

- Go 1.21 or higher
- PostgreSQL database (any version that supports pg_description)
- **LLM Provider** (choose one):
  - **Anthropic Claude**: API key required - Get yours at https://console.anthropic.com/
  - **Ollama**: Free, runs locally - Install from https://ollama.ai/

### LLM Provider Options

The server supports two LLM providers for natural language to SQL conversion:

#### Option 1: Anthropic Claude (Cloud)

**Pros:**
- State-of-the-art language models
- No local compute requirements
- Consistent performance

**Cons:**
- Requires API key and internet connection
- Usage-based pricing

**Setup:**
```bash
export ANTHROPIC_API_KEY="sk-ant-your-api-key-here"
```

#### Option 2: Ollama (Local)

**Pros:**
- Free and open source
- Runs completely locally
- No API key required
- No internet required after model download

**Cons:**
- Requires local compute resources
- Model quality varies

**Setup:**
```bash
# Install Ollama
# Visit https://ollama.ai/ for installation instructions

# Start Ollama server
ollama serve

# Download a model (no database connection required for this step)
# Recommended: qwen2.5-coder:32b for best SQL generation
ollama pull qwen2.5-coder:32b

# Alternative models:
# ollama pull qwen2.5-coder:7b  # Faster, smaller
# ollama pull codellama:13b
# ollama pull codellama:34b

# Run with Ollama (now database connection is required)
export POSTGRES_CONNECTION_STRING="postgres://user:password@localhost/dbname"
./bin/pgedge-postgres-mcp -llm-provider ollama -ollama-model qwen2.5-coder:32b
```

See [Configuration Guide](docs/CONFIGURATION.md) for more details on LLM provider configuration.

### Installation

```bash
# Clone the repository
git clone <repository-url>
cd pgedge-postgres-mcp

# Build the binary
make build
# Or: go build -o bin/pgedge-postgres-mcp ./cmd/pgedge-postgres-mcp
```

The binary will be created as `bin/pgedge-postgres-mcp`.

### Configure for Claude Desktop

Add to your MCP configuration file:

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`
**Windows**: `%APPDATA%\Claude\claude_desktop_config.json`
**Linux**: `~/.config/Claude/claude_desktop_config.json`

**Option 1: Using Anthropic Claude (default)**
```json
{
  "mcpServers": {
    "pgedge": {
      "command": "/absolute/path/to/pgedge-postgres-mcp/bin/pgedge-postgres-mcp",
      "env": {
        "POSTGRES_CONNECTION_STRING": "postgres://username:password@localhost:5432/database_name?sslmode=disable",
        "ANTHROPIC_API_KEY": "sk-ant-your-api-key-here"
      }
    }
  }
}
```

**Option 2: Using Ollama (local, free)**
```json
{
  "mcpServers": {
    "pgedge": {
      "command": "/absolute/path/to/pgedge-postgres-mcp/bin/pgedge-postgres-mcp",
      "args": ["-llm-provider", "ollama", "-ollama-model", "qwen2.5-coder:32b"],
      "env": {
        "POSTGRES_CONNECTION_STRING": "postgres://username:password@localhost:5432/database_name?sslmode=disable"
      }
    }
  }
}
```

**Note:** Before using Ollama, make sure to:
1. Install Ollama from https://ollama.ai/
2. Start Ollama: `ollama serve`
3. Download the model: `ollama pull qwen2.5-coder:32b`

**Important**: Use absolute paths, not relative paths.

### Start Using

1. Restart Claude Desktop
2. The server will automatically start when needed
3. Ask Claude questions about your database!

**Example queries:**
- "Show me all customers who made purchases in the last month"
- "What are the top 10 products by revenue?"
- "Describe the database schema"
- "Show me the PostgreSQL server settings"

## Usage Examples

### Basic Queries

```
"Show me all active users"
"What tables are available in the database?"
"List customers who haven't logged in for more than 30 days"
```

### Schema Discovery

```
"Show me the database schema"
"Describe the customers table"
"What columns does the orders table have?"
```

### System Information

```
"Show me the PostgreSQL version and system info"
"What are the current database settings?"
"Show me current database activity"
```

### Multi-Database Queries

```
"Show users at postgres://otherhost:5433/otherdb"
"Set default database to postgres://analytics-server/analytics"
```

For comprehensive examples including advanced patterns, see **[Query Examples](docs/EXAMPLES.md)**.

## Documentation

### Essential Guides

- **[Configuration Guide](docs/CONFIGURATION.md)** - Configuration file, environment variables, command line flags, and Claude Desktop setup
- **[Deployment Guide](docs/DEPLOYMENT.md)** - HTTP/HTTPS server deployment for direct API access
- **[Authentication Guide](docs/AUTHENTICATION.md)** - API token management for HTTP/HTTPS mode

### Feature Documentation

- **[Tools Documentation](docs/TOOLS.md)** - Complete reference for all ten MCP tools
- **[Resources Documentation](docs/RESOURCES.md)** - Complete reference for all nine MCP resources
- **[Query Examples](docs/EXAMPLES.md)** - Comprehensive collection of example queries and patterns

### Technical Guides

- **[MCP Protocol Guide](docs/MCP_PROTOCOL.md)** - Protocol implementation details and streaming support
- **[Security Guide](docs/SECURITY.md)** - Security best practices and guidelines
- **[Architecture Guide](docs/ARCHITECTURE.md)** - Code structure and how to extend the server
- **[Testing Guide](docs/TESTING.md)** - Unit tests, integration tests, and CI/CD
- **[CI/CD Guide](docs/CI_CD.md)** - Continuous integration workflows and release process
- **[Troubleshooting Guide](docs/TROUBLESHOOTING.md)** - Common issues and solutions

## How It Works

1. **Metadata Extraction**: On startup, the server connects to PostgreSQL and extracts:
   - All tables and views (excluding system schemas)
   - Column information (names, data types, nullability)
   - Comments from pg_description for both tables and columns

2. **Natural Language Processing**: When you ask a question:
   - The question and schema context are sent to Claude AI
   - Claude analyzes the schema and generates appropriate SQL
   - The generated SQL is executed against your database in a **read-only transaction**
   - Results are formatted and returned

3. **Read-Only Protection**: All queries via `query_database` are executed in read-only transactions, preventing INSERT, UPDATE, DELETE, and other data modifications.

## Adding Database Comments

To get the most value from this tool, add comments to your database objects:

```sql
-- Add table comment
COMMENT ON TABLE customers IS 'Customer information including contact details and preferences';

-- Add column comments
COMMENT ON COLUMN customers.created_at IS 'Timestamp when the customer account was created';
COMMENT ON COLUMN customers.segment IS 'Customer segment: premium, standard, or basic';

-- Add view comment
COMMENT ON VIEW active_customers IS 'Customers who have logged in within the last 90 days';
```

These comments help Claude understand your data model and generate more accurate queries.

## HTTP/HTTPS Mode

For direct API access and web integrations, run the server in HTTP mode:

```bash
# Start HTTP server
./bin/pgedge-postgres-mcp -http

# Start HTTPS server with TLS
./bin/pgedge-postgres-mcp -http -tls \
  -cert /path/to/server.crt \
  -key /path/to/server.key
```

**API Endpoints:**
- `POST /mcp/v1` - JSON-RPC 2.0 endpoint
- `GET /health` - Health check endpoint

HTTP mode includes built-in API token authentication. See [Authentication Guide](docs/AUTHENTICATION.md) and [Deployment Guide](docs/DEPLOYMENT.md) for details.

## Development

### Project Structure

```
pgedge-postgres-mcp/
â”œâ”€â”€ cmd/pgedge-postgres-mcp/  # Application entry point
â”œâ”€â”€ internal/                  # Private packages
â”‚   â”œâ”€â”€ auth/                  # API token authentication
â”‚   â”œâ”€â”€ config/                # Configuration management
â”‚   â”œâ”€â”€ database/              # PostgreSQL integration
â”‚   â”œâ”€â”€ llm/                   # Claude API client
â”‚   â”œâ”€â”€ mcp/                   # MCP protocol implementation
â”‚   â”œâ”€â”€ resources/             # MCP resource implementations
â”‚   â””â”€â”€ tools/                 # MCP tool implementations
â”œâ”€â”€ docs/                      # Documentation
â”œâ”€â”€ configs/                   # Configuration examples
â””â”€â”€ test/                      # Integration tests
```

### Running Tests

```bash
# Run all tests
go test ./...

# Run with verbose output and coverage
go test -v -cover ./...

# Run linting
golangci-lint run
```

See [Testing Guide](docs/TESTING.md) for details.

### Running Locally

For testing without an MCP client:

```bash
# Set environment variables
export POSTGRES_CONNECTION_STRING="postgres://localhost/mydb?sslmode=disable"
export ANTHROPIC_API_KEY="sk-ant-your-key"

# Run the server
./bin/pgedge-postgres-mcp
```

The server will read JSON-RPC messages from stdin and write responses to stdout.

### Testing with MCP Inspector

```bash
npx @modelcontextprotocol/inspector /path/to/bin/pgedge-postgres-mcp
```

## Security

**Key security features:**
- Read-only transaction enforcement for all queries
- API token authentication with expiration
- TLS/HTTPS support
- SHA256 token hashing
- File permission enforcement (0600)
- Database connection security (SSL/TLS)

See [Security Guide](docs/SECURITY.md) for comprehensive security best practices.

## Troubleshooting

### Quick Diagnostics

**Server exits immediately:**
- Check `POSTGRES_CONNECTION_STRING` is correct
- Verify PostgreSQL is running

**Tools not appearing in Claude Desktop:**
- Restart Claude Desktop completely
- Verify absolute path to binary in config
- Check JSON syntax in config file

**Natural language queries fail:**
- Verify `ANTHROPIC_API_KEY` is set and valid
- Check you have API credits at https://console.anthropic.com/

For detailed troubleshooting, see [Troubleshooting Guide](docs/TROUBLESHOOTING.md).

## License

This software is released under The PostgreSQL License.

## Support

- **Issues**: Report bugs and feature requests at the [GitHub Issues](https://github.com/pgEdge/pgedge-postgres-mcp/issues) page
- **Documentation**: Browse the [docs](docs/) directory for comprehensive guides
- **Examples**: See [Query Examples](docs/EXAMPLES.md) for usage patterns

## Related Projects

- [Model Context Protocol](https://modelcontextprotocol.io/) - Official MCP documentation
- [Claude Desktop](https://claude.ai/) - Anthropic's Claude AI assistant
- [PostgreSQL](https://www.postgresql.org/) - The world's most advanced open source database
