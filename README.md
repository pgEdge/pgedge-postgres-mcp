# pgEdge MCP Server

[![Build](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Build/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/build.yml)
[![Tests](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Tests/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/test.yml)

A Model Context Protocol (MCP) server written in Go that enables natural language queries against PostgreSQL databases. The server uses Claude AI to translate natural language questions into SQL queries by analyzing database metadata including table names, view names, column names, data types, and comments from pg_description.

> ðŸš§ WARNING
>
> This code was entirely generated by Claude Code. It has not been human reviewed and MUST NOT be put into production or released as stable code without a thorough review!

## Features

- **Natural Language to SQL**: Convert plain English questions into SQL queries using Claude AI
- **Read-Only Protection**: All generated queries are executed in read-only transactions to prevent accidental or malicious data modifications
- **Comprehensive Schema Analysis**: Extracts and utilizes:
  - Table and view names
  - Column names and data types
  - Nullability constraints
  - Comments from pg_description (table and column descriptions)
  - Schema information
- **Multi-Database Support**: Query multiple PostgreSQL databases dynamically by specifying connection strings in queries
- **Configuration Management**: View, modify, and get baseline configuration recommendations for NEW PostgreSQL installations
- **Bloat Analysis**: Analyze tables and indexes for bloat to determine when vacuuming or reindexing is required
- **Configuration File Access**: Read PostgreSQL configuration files (postgresql.conf, pg_hba.conf, pg_ident.conf) and server logs
- **MCP Protocol**: Implements the Model Context Protocol for stdio communication
- **Ten MCP Tools**: Execute queries, retrieve schema, modify configuration, get configuration recommendations, analyze bloat, read config files and logs, and read resources
  - See **[Tools Documentation](docs/TOOLS.md)** for detailed information
- **Nine MCP Resources**: System information and PostgreSQL statistics (pg_stat_* views)
  - See **[Resources Documentation](docs/RESOURCES.md)** for detailed information

## Documentation

For additional documentation, please see:

- **[Query Examples](docs/EXAMPLES.md)** - Comprehensive collection of example queries including basic data queries, schema discovery, multi-database queries, and advanced usage patterns
- **[Tools Documentation](docs/TOOLS.md)** - Detailed information about all ten MCP tools and how to use them
- **[Resources Documentation](docs/RESOURCES.md)** - Complete reference for all nine MCP resources including system info and statistics
- **[Testing Guide](docs/TESTING.md)** - Information about unit tests, integration tests, linting, and CI/CD
- **[Architecture Guide](docs/ARCHITECTURE.md)** - Detailed information about the project structure, components, data flow, and how to extend the server with new tools, resources, and prompts
- **[Troubleshooting Guide](docs/TROUBLESHOOTING.md)** - Comprehensive troubleshooting steps for common issues, connection problems, and debugging techniques

## Prerequisites

- Go 1.21 or higher
- PostgreSQL database (any version that supports pg_description)
- Anthropic API key (for Claude AI)

## Installation

### From Source

1. Clone the repository:
```bash
git clone <repository-url>
cd pgedge-postgres-mcp
```

2. Build the binary:
```bash
make build
# Or: go build -o bin/pgedge-postgres-mcp ./cmd/pgedge-postgres-mcp
```

3. The binary will be created as `bin/pgedge-postgres-mcp`.

## Configuration

The server supports multiple configuration methods with the following priority (highest to lowest):
1. **Command line flags** (highest priority)
2. **Environment variables**
3. **Configuration file**
4. **Hard-coded defaults** (lowest priority)

### Configuration File

The server can read configuration from a YAML file, making it easier to manage settings without environment variables.

**Default Location**: `pgedge-postgres-mcp.yaml` in the same directory as the binary

**Custom Location**: Use the `-config` flag to specify a different path

**Example Configuration**:
```yaml
database:
  connection_string: "postgres://localhost/postgres?sslmode=disable"

anthropic:
  api_key: "sk-ant-your-api-key-here"
  model: "claude-sonnet-4-5"

http:
  enabled: false
  address: ":8080"
  tls:
    enabled: false
    cert_file: "./server.crt"
    key_file: "./server.key"
    chain_file: ""
```

A complete example configuration file is available at [configs/pgedge-postgres-mcp.yaml.example](configs/pgedge-postgres-mcp.yaml.example).

**Creating a Configuration File**:
```bash
# Copy the example to the binary directory
cp configs/pgedge-postgres-mcp.yaml.example bin/pgedge-postgres-mcp.yaml

# Edit with your settings
vim bin/pgedge-postgres-mcp.yaml

# Run the server (automatically loads config from default location)
./bin/pgedge-postgres-mcp
```

### Command Line Flags

All configuration options can be overridden via command line flags:

- `-config` - Path to configuration file (default: same directory as binary)
- `-db` - PostgreSQL connection string
- `-api-key` - Anthropic API key
- `-model` - Claude model to use
- `-http` - Enable HTTP transport mode
- `-addr` - HTTP server address
- `-https` - Enable HTTPS (requires -http)
- `-cert` - Path to TLS certificate file
- `-key` - Path to TLS key file
- `-chain` - Path to TLS certificate chain file

Example:
```bash
./bin/pgedge-postgres-mcp \
  -db "postgres://localhost/mydb" \
  -api-key "sk-ant-..." \
  -http \
  -addr ":9090"
```

### Environment Variables

The server also supports environment variables for configuration:

- `POSTGRES_CONNECTION_STRING` (required): PostgreSQL connection string
  - Format: `postgres://username:password@host:port/database?sslmode=disable`
  - Example: `postgres://myuser:mypass@localhost:5432/mydb?sslmode=disable`

- `ANTHROPIC_API_KEY` (required for natural language queries): Your Anthropic API key
  - Get yours at: https://console.anthropic.com/

- `ANTHROPIC_MODEL` (optional): Claude model to use
  - Default: `claude-sonnet-4-5`
  - Other options: `claude-haiku-4-5`, `claude-opus-4-1`

### Configuration File for Claude Desktop

To use this MCP server with Claude Desktop, add it to your MCP configuration file:

**Location**:
- macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
- Windows: `%APPDATA%\Claude\claude_desktop_config.json`
- Linux: `~/.config/Claude/claude_desktop_config.json`

**Configuration**:
```json
{
  "mcpServers": {
    "pgedge": {
      "command": "/absolute/path/to/pgedge-postgres-mcp/bin/pgedge-postgres-mcp",
      "env": {
        "POSTGRES_CONNECTION_STRING": "postgres://username:password@localhost:5432/database_name?sslmode=disable",
        "ANTHROPIC_API_KEY": "sk-ant-your-api-key-here",
        "ANTHROPIC_MODEL": "claude-sonnet-4-5"
      }
    }
  }
}
```

Replace `/absolute/path/to/pgedge-postgres-mcp` with the full path to your project directory.

## Usage

### With Claude Desktop

1. Configure the server in your Claude Desktop config (see above)
2. Restart Claude Desktop
3. The server will automatically start when needed
4. Use natural language to interact with your database

For detailed information about available tools, see **[Tools Documentation](docs/TOOLS.md)**.

### Query Examples

Once configured, you can ask Claude natural language questions about your data:

**Basic Queries:**
- "Show me all customers who made purchases in the last month"
- "What are the top 10 products by revenue?"
- "List all users who haven't logged in for more than 30 days"

**Schema Discovery:**
- "Show me the database schema"
- "What tables are available?"
- "Describe the customers table"

**System Information:**
- "Show me the output from pg://system_info"
- "Read the pg://settings resource"
- "What are the current database statistics?"

**Multi-Database Queries:**
- "Show users at postgres://localhost:5433/other_db" (temporary connection)
- "Set default database to postgres://analytics-server/analytics" (change default)

For a comprehensive collection of examples including advanced queries, multi-database patterns, and real-world scenarios, see **[Query Examples](docs/EXAMPLES.md)**.

### Multi-Database Support

The server supports querying multiple PostgreSQL databases dynamically by including connection strings in your queries:

- **Temporary queries**: Include `at postgres://...` in your query to connect temporarily
- **Change default**: Use `set default database to postgres://...` to switch permanently
- **Connection format**: `postgres://[user[:password]@][host][:port][/dbname][?params]`

See the **[Query Examples](docs/EXAMPLES.md)** guide for detailed examples and patterns.

## How It Works

1. **Metadata Extraction**: On startup, the server connects to PostgreSQL and extracts:
   - All tables and views (excluding system schemas)
   - Column information (names, data types, nullability)
   - Comments from pg_description for both tables and columns

2. **Natural Language Processing**: When you ask a question:
   - The question and schema context are sent to Claude AI
   - Claude analyzes the schema and generates appropriate SQL
   - The generated SQL is executed against your database
   - Results are formatted and returned

3. **Schema Context**: The LLM receives rich context including:
   ```
   schema_name.table_name (TABLE/VIEW)
     Description: [from pg_description]
     Columns:
       - column_name (data_type) [NULL] - [column description]
       ...
   ```

## Adding Database Comments

To get the most value from this tool, add comments to your database objects:

```sql
-- Add table comment
COMMENT ON TABLE customers IS 'Customer information including contact details and preferences';

-- Add column comments
COMMENT ON COLUMN customers.created_at IS 'Timestamp when the customer account was created';
COMMENT ON COLUMN customers.last_login IS 'Last successful login timestamp';
COMMENT ON COLUMN customers.segment IS 'Customer segment: premium, standard, or basic';

-- Add view comment
COMMENT ON VIEW active_customers IS 'Customers who have logged in within the last 90 days';
```

These comments help Claude understand your data model and generate more accurate queries.

## Development

### Project Structure

```
pgedge-postgres-mcp/
â”œâ”€â”€ cmd/pgedge-postgres-mcp/          # Application entry point
â”œâ”€â”€ internal/                # Private packages
â”‚   â”œâ”€â”€ database/            # PostgreSQL integration
â”‚   â”œâ”€â”€ llm/                 # Claude API client
â”‚   â”œâ”€â”€ mcp/                 # MCP protocol
â”‚   â””â”€â”€ tools/               # Tool implementations
â”œâ”€â”€ docs/                    # Documentation
â”œâ”€â”€ configs/                 # Configuration examples
â””â”€â”€ bin/                     # Compiled binaries
```

For detailed architecture information, see [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md).

### Running Locally

For testing without an MCP client:

```bash
# Set environment variables
export POSTGRES_CONNECTION_STRING="postgres://localhost/mydb?sslmode=disable"
export ANTHROPIC_API_KEY="sk-ant-your-key"

# Run the server
./bin/pgedge-postgres-mcp
```

The server will read JSON-RPC messages from stdin and write responses to stdout.

### Running as HTTP/HTTPS Server

The server supports two transport modes:

1. **stdio mode (default)**: JSON-RPC over standard input/output - used by Claude Desktop
2. **HTTP/HTTPS mode**: JSON-RPC over HTTP - for direct API access

#### Command Line Options

```bash
./bin/pgedge-postgres-mcp [options]

Options:
  -http              Enable HTTP transport mode (default: stdio)
  -addr string       HTTP server address (default ":8080")
  -https             Enable HTTPS (requires -http)
  -cert string       Path to TLS certificate file
  -key string        Path to TLS key file
  -chain string      Path to TLS certificate chain file (optional)
```

**Note**: TLS options (`-https`, `-cert`, `-key`, `-chain`) require the `-http` flag.

#### HTTP Mode

Run the server in HTTP mode for direct API access:

```bash
# Set environment variables
export POSTGRES_CONNECTION_STRING="postgres://localhost/mydb?sslmode=disable"
export ANTHROPIC_API_KEY="sk-ant-your-key"

# Start HTTP server on port 8080
./bin/pgedge-postgres-mcp -http

# Or specify a custom address
./bin/pgedge-postgres-mcp -http -addr ":3000"
```

The server provides two endpoints:

- **POST /mcp/v1**: JSON-RPC 2.0 endpoint for MCP requests
- **GET /health**: Health check endpoint

Example using curl:

```bash
# Health check
curl http://localhost:8080/health

# Initialize connection
curl -X POST http://localhost:8080/mcp/v1 \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "initialize",
    "params": {
      "protocolVersion": "2024-11-05",
      "capabilities": {},
      "clientInfo": {
        "name": "test-client",
        "version": "1.0.0"
      }
    }
  }'

# List available tools
curl -X POST http://localhost:8080/mcp/v1 \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 2,
    "method": "tools/list",
    "params": {}
  }'
```

#### HTTPS Mode

For production deployments, use HTTPS with TLS certificates:

```bash
# Generate self-signed certificate for testing
openssl req -x509 -newkey rsa:4096 -keyout server.key -out server.crt \
  -days 365 -nodes -subj "/CN=localhost"

# Start HTTPS server
./bin/pgedge-postgres-mcp -http -https \
  -cert server.crt \
  -key server.key
```

For production, use certificates from a trusted Certificate Authority (CA):

```bash
# With CA-signed certificates
./bin/pgedge-postgres-mcp -http -https \
  -cert /path/to/server.crt \
  -key /path/to/server.key \
  -chain /path/to/ca-chain.crt
```

**Certificate Requirements:**
- Minimum TLS version: 1.2
- Certificate and key must be PEM-encoded
- Chain file is optional but recommended for CA-signed certificates
- If paths are not specified, server looks in the same directory as the binary

Example HTTPS request:

```bash
# With self-signed certificate (testing only)
curl -k https://localhost:8080/health

# With trusted certificate
curl https://yourdomain.com:8080/health
```

#### Security Considerations for HTTP/HTTPS Mode

1. **Always use HTTPS in production**
   - HTTP mode sends data in plaintext
   - HTTPS encrypts all communication including API keys and database results

2. **Protect your TLS private keys**
   - Store keys with restricted file permissions (chmod 600)
   - Never commit keys to version control
   - Rotate certificates before expiration

3. **Network access control**
   - Use firewall rules to restrict access
   - Consider running behind a reverse proxy (nginx, HAProxy)
   - Implement rate limiting and authentication at the proxy level

4. **Database connection security**
   - Use SSL for PostgreSQL connections
   - Use connection strings with minimal required privileges
   - Consider using connection pooling for production workloads

### Testing

The project includes comprehensive testing at multiple levels:

```bash
# Run all tests (unit + integration + linting)
go test ./...

# Run with verbose output and coverage
go test -v -cover ./...
```

**Test Coverage:**
- Unit tests for all major components
- Integration tests for the compiled MCP server binary
- Automated linting with golangci-lint
- MCP protocol compliance tests

For detailed information about testing, including integration tests, CI/CD workflows, and troubleshooting, see **[Testing Guide](docs/TESTING.md)**.

### Testing with MCP Inspector

You can test the server using the MCP Inspector tool:

```bash
npx @modelcontextprotocol/inspector /path/to/bin/pgedge-postgres-mcp
```

## CI/CD

The project uses GitHub Actions for continuous integration with automated build and test workflows. Tests run against multiple Go versions (1.21, 1.22, 1.23) and PostgreSQL versions (14, 15, 16, 17).

For detailed information about CI/CD workflows and configuration, see **[Testing Guide](docs/TESTING.md)**.

## MCP Protocol Implementation

This server implements the Model Context Protocol version `2024-11-05` with support for:

- **Tools**: Ten callable functions for database interaction, configuration, maintenance analysis, and configuration file access
- **Resources**: Nine read-only resources for system information and statistics
- **Prompts**: Custom prompts for common database tasks

For detailed documentation:
- **[Tools Documentation](docs/TOOLS.md)** - Complete reference for all ten MCP tools
- **[Resources Documentation](docs/RESOURCES.md)** - Complete reference for all nine MCP resources

## Security Considerations

1. **Database Credentials**: Store connection strings securely
   - Use environment variables
   - Never commit credentials to version control
   - Consider using password files or secret management systems

2. **API Keys**: Protect your Anthropic API key
   - Store in environment variables
   - Rotate keys regularly
   - Monitor API usage

3. **Query Safety**: The server executes generated SQL with protections
   - **Read-Only by Default**: All queries through `query_database` are executed in read-only transactions using `SET TRANSACTION READ ONLY`, preventing INSERT, UPDATE, DELETE, and other data modifications
   - Write operations will fail with: "cannot execute ... in a read-only transaction"
   - Review the SQL before execution when possible
   - Use read-only database users for additional protection
   - Monitor for suspicious queries

4. **Configuration Management**: The `set_pg_configuration` tool modifies server settings
   - Requires PostgreSQL superuser privileges
   - Changes persist across server restarts via `postgresql.auto.conf`
   - Test configuration changes in development before applying to production
   - Some parameters require a server restart to take effect
   - Keep backups of configuration files before making changes

5. **Network Security**:
   - Use SSL/TLS for PostgreSQL connections when possible
   - Restrict database access to trusted networks

## Troubleshooting

**For detailed troubleshooting, see [docs/TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)**

### Quick Diagnostics

**Check logs:**
```bash
# macOS
tail -f ~/Library/Logs/Claude/mcp*.log

# Look for these messages:
# Database ready: X tables/views loaded
```

### Common Issues

**Server exits immediately:**
- Check `POSTGRES_CONNECTION_STRING` is correct
- Verify PostgreSQL is running
- See detailed solutions in [docs/TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)

**Tools not appearing:**
- Restart Claude Desktop completely
- Verify MCP config has absolute path to binary
- Check JSON syntax in config file

**Natural language queries fail:**
- Set `ANTHROPIC_API_KEY` in MCP config
- Verify API key is valid at https://console.anthropic.com/
- Check you have API credits

**Poor query results:**
- Add COMMENT statements to your database
- Be more specific in your questions
- Ask Claude to "show me the database schema" first

## License

This software is released under [The PostgreSQL License](LICENSE).

Copyright (c) 2025, pgEdge, Inc.

## Support

For issues, questions, or contributions, please use the [GitHub issue tracker](https://github.com/pgEdge/pgedge-postgres-mcp/issues).
