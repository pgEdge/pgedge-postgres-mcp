# pgEdge MCP Server

[![Build](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Build/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/build.yml)
[![Tests](https://github.com/pgEdge/pgedge-postgres-mcp/workflows/Tests/badge.svg)](https://github.com/pgEdge/pgedge-postgres-mcp/actions/workflows/test.yml)

A Model Context Protocol (MCP) server that enables **natural language queries** against PostgreSQL databases. Ask questions in plain English and get SQL results automatically.

```
"Show me all customers who made purchases in the last month"
"What are the top 10 products by revenue?"
"Which tables have the most bloat?"
```

> üöß **WARNING**: This code was entirely generated by Claude Code. It has not been human reviewed and MUST NOT be put into production without thorough review!

## Key Features

- ‚ú® **Natural Language to SQL** - Ask questions in plain English, get SQL results
- üîí **Read-Only Protection** - All queries run in read-only transactions
- ü§ñ **Dual LLM Support** - Use Anthropic Claude (cloud) or Ollama (local/free)
- üìä **12 Resources** - Access PostgreSQL statistics (pg_stat_*, pg_statio_*)
- üõ†Ô∏è **11 Tools** - Query execution, schema analysis, config management, bloat analysis
- üåê **HTTP/HTTPS Mode** - Direct API access with token authentication
- üîê **Secure** - TLS support, token auth, read-only enforcement

## Quick Start

### 1. Installation

```bash
git clone <repository-url>
cd pgedge-postgres-mcp
make build
```

### 2. Choose Your LLM Provider

**Option A: Anthropic Claude (Cloud)**
```bash
export PGEDGE_ANTHROPIC_API_KEY="sk-ant-your-key"
```
Get your API key at https://console.anthropic.com/

**Option B: Ollama (Local/Free)**
```bash
# Install from https://ollama.ai/
ollama serve
ollama pull qwen2.5-coder:32b
```

### 3. Configure for Claude Desktop

**macOS**: `~/Library/Application Support/Claude/claude_desktop_config.json`

**With Anthropic Claude:**
```json
{
  "mcpServers": {
    "pgedge": {
      "command": "/absolute/path/to/bin/pgedge-postgres-mcp",
      "env": {
        "ANTHROPIC_API_KEY": "sk-ant-your-key"
      }
    }
  }
}
```

**With Ollama:**
```json
{
  "mcpServers": {
    "pgedge": {
      "command": "/absolute/path/to/bin/pgedge-postgres-mcp",
      "args": ["-llm-provider", "ollama", "-ollama-model", "qwen2.5-coder:32b"]
    }
  }
}
```

### 4. Connect to Your Database

1. Restart Claude Desktop
2. Configure your database connection:

```
"Set my database connection to postgres://user:pass@localhost:5432/mydb"
```

3. Now ask questions about your database!

```
"Show me the database schema"
"What are the current PostgreSQL settings?"
"Find all users who registered last week"
```

> **Note:** Database connections are configured at runtime via the `set_database_connection` tool for security. This keeps credentials out of config files.

## Example Queries

**Schema Discovery:**
```
"What tables exist in this database?"
"Describe the customers table"
```

**Data Analysis:**
```
"Show the top 10 customers by total order value"
"Find orders with unusual shipping times"
```

**System Monitoring:**
```
"Show current database connections"
"Which tables need vacuuming?"
"What's the cache hit ratio?"
```

## HTTP/HTTPS Mode

Run as a standalone HTTP server for direct API access:

```bash
# HTTP
./bin/pgedge-postgres-mcp -http

# HTTPS with TLS
./bin/pgedge-postgres-mcp -http -tls \
  -cert server.crt \
  -key server.key
```

**API Endpoint:** `POST http://localhost:8080/mcp/v1`

Example request:
```bash
curl -X POST http://localhost:8080/mcp/v1 \
  -H "Authorization: Bearer your-token" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
      "name": "query_database",
      "arguments": {
        "natural_language_query": "Show all users"
      }
    }
  }'
```

## Documentation

üìö **[Complete Documentation](docs/index.md)** - Comprehensive guides and references

### Essential Guides
- **[Configuration Guide](docs/configuration.md)** - Config file, environment variables, CLI flags
- **[Tools Documentation](docs/tools.md)** - All 11 MCP tools reference
- **[Resources Documentation](docs/resources.md)** - All 12 MCP resources reference
- **[Query Examples](docs/examples.md)** - Comprehensive usage examples
- **[Deployment Guide](docs/deployment.md)** - HTTP/HTTPS production deployment
- **[Authentication Guide](docs/authentication.md)** - API token management

### Technical Guides
- **[MCP Protocol Guide](docs/mcp_protocol.md)** - Protocol implementation details
- **[Security Guide](docs/security.md)** - Security best practices
- **[Architecture Guide](docs/architecture.md)** - Code structure and extension
- **[Testing Guide](docs/testing.md)** - Unit and integration tests
- **[Troubleshooting Guide](docs/troubleshooting.md)** - Common issues and solutions

## How It Works

1. **Configure** - Call `set_database_connection` tool with your PostgreSQL connection string
2. **Connect** - Server connects to PostgreSQL and extracts schema metadata
3. **Ask** - You ask questions in natural language via Claude Desktop
4. **Translate** - LLM converts your question to SQL using schema context
5. **Execute** - SQL runs in a **read-only transaction**
6. **Return** - Results formatted and returned to Claude

**Read-Only Protection:** All queries run in read-only mode - no INSERT, UPDATE, DELETE, or DDL operations allowed.

## Development

```bash
# Run tests (uses TEST_POSTGRES_CONNECTION_STRING)
export TEST_POSTGRES_CONNECTION_STRING="postgres://localhost/postgres?sslmode=disable"
go test ./...

# Run with coverage
go test -v -cover ./...

# Run linting
golangci-lint run

# Run locally
export PGEDGE_ANTHROPIC_API_KEY="your-key"
./bin/pgedge-postgres-mcp
# Then use set_database_connection tool to connect to database
```

## Security

- ‚úÖ Read-only transaction enforcement
- ‚úÖ API token authentication with expiration
- ‚úÖ TLS/HTTPS support
- ‚úÖ SHA256 token hashing
- ‚úÖ File permission enforcement (0600)
- ‚úÖ Input validation and sanitization

See **[Security Guide](docs/security.md)** for comprehensive security documentation.

## Troubleshooting

**Tools not visible in Claude Desktop?**
- Use absolute paths in config
- Restart Claude Desktop completely
- Check JSON syntax

**Database connection errors?**
- Call `set_database_connection` tool first with your connection string
- Verify PostgreSQL is running: `pg_isready`
- Check connection string format: `postgres://user:pass@host:port/dbname`

**Natural language queries fail?**
- Verify `PGEDGE_ANTHROPIC_API_KEY` is set (for Anthropic)
- Ensure Ollama is running: `ollama serve` (for Ollama)
- Check model is downloaded: `ollama list`

See **[Troubleshooting Guide](docs/troubleshooting.md)** for detailed solutions.

## License

This software is released under The PostgreSQL License.

## Support

- **üìñ Documentation**: [docs/index.md](docs/index.md)
- **üêõ Issues**: [GitHub Issues](https://github.com/pgEdge/pgedge-postgres-mcp/issues)
- **üí° Examples**: [Query Examples](docs/examples.md)

## Related Projects

- [Model Context Protocol](https://modelcontextprotocol.io/) - MCP specification
- [Claude Desktop](https://claude.ai/) - Anthropic's Claude AI assistant
- [Ollama](https://ollama.ai/) - Run LLMs locally
- [PostgreSQL](https://www.postgresql.org/) - The world's most advanced open source database
